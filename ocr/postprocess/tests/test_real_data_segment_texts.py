import logging
import pickle
from unittest import TestCase

from ocr.postprocess import segment_texts
from ocr.postprocess.add_timestamp import add_timestamp

logging.basicConfig(level=logging.DEBUG)

EXPECTED_SEGMENT = [
    ['パーソンは\nカバルドンを くりだした', 'パーソンは\nカバルドンを くりだした!', 'パーソンは\nカバルドンを くりだした!', 'パーソンは\nカバルドンを くりだした!',
     'パーソンは\nカバルドンを くりだした!', 'パーソンは\nカバルドンを くりだした!', 'パーソンは\nカバルドンを くりだした!', 'ゆけっ! ウオノラゴン!', 'ゆけっ! ウオノラゴン!',
     'ゆけっ! ウオノラゴン!', 'ゆけっ! ウオノラゴン!', 'ゆけっ! ウオノラゴン!', '砂あらしが 吹き始めた!', '砂あらしが 吹き始めた!', '通信待機中…', 'ウオノラゴンの\nエラがみ!',
     'ウオノラゴンの\nエラがみ!', 'ウオノラゴンの\nエラがみ!', '効果は バツグンだ!', 'ウオノラゴンは\nゴツゴツメットで ダメージを', 'ウオノラゴンは\nゴツゴツメットで ダメージを受けた!',
     '相手の カバルドンは たおれた!', '相手の カバルドンは たおれた!', '砂あらしが\nウォノラゴン', '砂あらしが\nウオノラゴンを 襲う!', '通信待機中 ...', '通信待機中 ...', '通信待機中…',
     '通信待機中…', '通信待機中…', '通信待機中 ...', '通信待機中…', '通信待機中 ...', '通信待機中 ...', '通信待機中 ...', 'パーソンは\nカイリューを くり',
     'パーソンは\nカイリューを くりだした!', '通信待機中…', '通信待機中…', '通信待機中 ··', 'ウオノラゴンの\nエラがみ!', 'ウオノラゴンの\nエラがみ!', 'ウオノラゴンの\nエラがみ!',
     '実は 今ひとつのようだ ·····', '効果は 今ひとつのようだ ……', '相手の カイリューの\nりゅうのまい!', '相手の カイリューの\nりゆうのまい!', '相手の カイリューの\nりゆうのまい!',
     '相手の カイリューの\n攻撃が 上がった', '相手の カイリューの\n攻撃が 上がった!', '相手の カイリューの\n素早さが 上がっ', '相手の カイリューの\n素早さが 上がった!',
     '砂あらしが\n相手の カイリューを', '砂あらしが\n相手の カイリューを 襲う!', '砂あらしが\nウオノラゴンを 襲う!', '通信待機中…', '通信待機中…', '通信待機中 …..', '通信待機中…',
     '通信待機中 ……', '通信待機中…', '通信待機中…', '通信待機中…', '通信待機中…', '相手の カイリューの\nダイジェット!', '相手の カイリューの\nダイジェット!',
     '相手の カイリューの\n素早さが 上がった!', 'ウオノラゴンは たおれた!'],
    [ '相手の カイリューは\n命が 少し', '相手の カイリューは\n命が 少し削られた!', '砂あらしが\n相手の カイリュー', '砂あらしが\n相手の カイリューを 襲う!', '通信待機中…', '通信待機中 ...', '通信待機中 ··', '通信待機中…', '任せた! トゲキッス!', '通信待機中…', '相手の カイリューの\nダイウォール!', '相手の カイリューの\nダイウォール!', '相手の カイリューの\nダイウォール!', 'トゲキッスの\nダイフェアリー', 'トゲキッスの\nダイフェアリー', 'トゲキッスの\nダイフェアリー', '相手の カイリューは\n攻撃から 身を守った!', '砂あらしが\n相手の カイリューを 襲う!', '砂あらしが\nトゲキッスを 襲う」', '通信待機中…', '通信待機中 ……', '通信待機中 ··', '通信待機中…', '相手の カイリューの\nダイジェット!', '相手の カイリューの\nダイジェット!', '相手の カイリューの\n素早さが 上がった!', '相手の カイリューの\n素早さが 上がった!', '相手の カイリューは\n命が', '相手の カイリューは\n命が 少し削られた!', 'トゲキッスの\nダイフェアリー!', 'トゲキッスの\nダイフェアリー!', 'トゲキッスの\nダイフェアリー!', '効果は バツグンだ!', '足下に 霧が立ち込めた!', '相手の カイリューは たおれた!', '砂あらしが おさまった!', '通信待機中…', '通信待機中 …...', '通信待機中…', '通信待機中 ….', '通信待機中…', '通信待機中…', '通信待機中…', '通信待機中…', '通信待機中…', 'パーソンは\nミミッキュを くりだした!', '通信待機中 ....', '通信待機中…', '通信待機中…', '通信待機中…', '相手の ミミッキュは\nつるぎのまいを つかった!', '相手の ミミッキュは\nつるぎのまいを つかった!', '相手の ミミッキュは\nつるぎのまいを つかった!', '相手の ミミッキュの\n攻撃が ぐーんと上がった!', '相手の ミミッキュの\n攻撃が ぐーんと上がった!', 'トゲキッスの\nダイジェット!', 'トゲキッスの\nダイジェット!', 'トゲキッスの\nダイジェット!', 'トゲキッスの\n素早さが 上がった!', 'ばけのかわが みがわりに なった!', '相手の ミミッキュの\nばけのかわが はがれた!', '通信待機中…', '通信待機中 ....', '通信待機中…', '相手の ミミッキュの\nかげうち!', '相手の ミミッキュの\nかけうち!', '相手の ミミッキュの\nかげうち!', 'トゲキッスの\nエアスラッシュ!'],
    [ 'トゲキッスの\nエアスラッシュ!', 'トゲキッスの\nエアスラッシュ!', '通信待機中…', '通信待機中…', '通信待機中…', '通信待機中…', '通信待機中…', '相手の ミミッキュの\nかげうち!', '相手の ミミッキュの\nかげうち!', '相手の ミミッキュの\nかげうち!', 'トゲキッスは たおれた!', 'トゲキッスは たおれた!', '通信待機中…', '通信待機中 ...', '通信待機中 ...', 'がんばれ! ウインディ!', '通信待機中…', '通信待機中 ……', '通信待機中…', '相手の ミミッキュの\nドレインパンチ!', '相手の ミミッキュの\nドレインパンチ!', '相手の ミミッキュの\nドレインパンチ!', 'ウインディから\n体力を 吸い取った!', 'ウインディの\nフレアドライブ!', 'ウインディの\nフレアドライブ!', 'ウインディの\nフレアドライブ!', '相手の ミミッキュは たおれた!', 'ウインディは\n反動による ダメージを 受けた!', 'ウインディは\n命が 少し削られた!', 'パーソンとの\n勝負に 勝つた!']
]

EXPECTED_TIMESTAMPED = {735: 'パーソンは\nカバルドンを くりだした', 750: 'パーソンは\nカバルドンを くりだした!', 765: 'パーソンは\nカバルドンを くりだした!', 780: 'パーソンは\nカバルドンを くりだした!', 795: 'パーソンは\nカバルドンを くりだした!', 810: 'パーソンは\nカバルドンを くりだした!', 825: 'パーソンは\nカバルドンを くりだした!', 870: 'ゆけっ! ウオノラゴン!', 885: 'ゆけっ! ウオノラゴン!', 900: 'ゆけっ! ウオノラゴン!', 915: 'ゆけっ! ウオノラゴン!', 930: 'ゆけっ! ウオノラゴン!', 1125: '砂あらしが 吹き始めた!', 1140: '砂あらしが 吹き始めた!', 1260: '通信待機中…', 1290: 'ウオノラゴンの\nエラがみ!', 1305: 'ウオノラゴンの\nエラがみ!', 1320: 'ウオノラゴンの\nエラがみ!', 1440: '効果は バツグンだ!', 1485: 'ウオノラゴンは\nゴツゴツメットで ダメージを', 1500: 'ウオノラゴンは\nゴツゴツメットで ダメージを受けた!', 1515: '相手の カバルドンは たおれた!', 1530: '相手の カバルドンは たおれた!', 1620: '砂あらしが\nウォノラゴン', 1635: '砂あらしが\nウオノラゴンを 襲う!', 1725: '通信待機中 ...', 1740: '通信待機中 ...', 1755: '通信待機中…', 1770: '通信待機中…', 1785: '通信待機中…', 1800: '通信待機中 ...', 1815: '通信待機中…', 1830: '通信待機中 ...', 1845: '通信待機中 ...', 1860: '通信待機中 ...', 1875: 'パーソンは\nカイリューを くり', 1890: 'パーソンは\nカイリューを くりだした!', 2415: '通信待機中…', 2430: '通信待機中…', 2445: '通信待機中 ··', 2475: 'ウオノラゴンの\nエラがみ!', 2490: 'ウオノラゴンの\nエラがみ!', 2505: 'ウオノラゴンの\nエラがみ!', 2595: '実は 今ひとつのようだ ·····', 2610: '効果は 今ひとつのようだ ……', 2640: '相手の カイリューの\nりゅうのまい!', 2655: '相手の カイリューの\nりゆうのまい!', 2670: '相手の カイリューの\nりゆうのまい!', 2835: '相手の カイリューの\n攻撃が 上がった', 2850: '相手の カイリューの\n攻撃が 上がった!', 2865: '相手の カイリューの\n素早さが 上がっ', 2880: '相手の カイリューの\n素早さが 上がった!', 2895: '砂あらしが\n相手の カイリューを', 2910: '砂あらしが\n相手の カイリューを 襲う!', 2985: '砂あらしが\nウオノラゴンを 襲う!', 3135: '通信待機中…', 3150: '通信待機中…', 3165: '通信待機中 …..', 3180: '通信待機中…', 3195: '通信待機中 ……', 3210: '通信待機中…', 3225: '通信待機中…', 3240: '通信待機中…', 3255: '通信待機中…', 3975: '相手の カイリューの\nダイジェット!', 3990: '相手の カイリューの\nダイジェット!', 4245: '相手の カイリューの\n素早さが 上がった!', 4275: 'ウオノラゴンは たおれた!', 4395: '相手の カイリューは\n命が 少し', 4410: '相手の カイリューは\n命が 少し削られた!', 4425: '砂あらしが\n相手の カイリュー', 4440: '砂あらしが\n相手の カイリューを 襲う!', 4770: '通信待機中…', 4785: '通信待機中 ...', 4800: '通信待機中 ··', 4815: '通信待機中…', 4830: '任せた! トゲキッス!', 5235: '通信待機中…', 5940: '相手の カイリューの\nダイウォール!', 5955: '相手の カイリューの\nダイウォール!', 5970: '相手の カイリューの\nダイウォール!', 6045: 'トゲキッスの\nダイフェアリー', 6060: 'トゲキッスの\nダイフェアリー', 6075: 'トゲキッスの\nダイフェアリー', 6150: '相手の カイリューは\n攻撃から 身を守った!', 6180: '砂あらしが\n相手の カイリューを 襲う!', 6255: '砂あらしが\nトゲキッスを 襲う」', 6480: '通信待機中…', 6495: '通信待機中 ……', 6510: '通信待機中 ··', 6525: '通信待機中…', 6570: '相手の カイリューの\nダイジェット!', 6585: '相手の カイリューの\nダイジェット!', 6840: '相手の カイリューの\n素早さが 上がった!', 6855: '相手の カイリューの\n素早さが 上がった!', 6885: '相手の カイリューは\n命が', 6900: '相手の カイリューは\n命が 少し削られた!', 6945: 'トゲキッスの\nダイフェアリー!', 6960: 'トゲキッスの\nダイフェアリー!', 6975: 'トゲキッスの\nダイフェアリー!', 7185: '効果は バツグンだ!', 7365: '足下に 霧が立ち込めた!', 7395: '相手の カイリューは たおれた!', 7620: '砂あらしが おさまった!', 7755: '通信待機中…', 7770: '通信待機中 …...', 7785: '通信待機中…', 7800: '通信待機中 ….', 7815: '通信待機中…', 7830: '通信待機中…', 7845: '通信待機中…', 7860: '通信待機中…', 7875: '通信待機中…', 7905: 'パーソンは\nミミッキュを くりだした!', 8190: '通信待機中 ....', 8205: '通信待機中…', 8220: '通信待機中…', 8235: '通信待機中…', 8295: '相手の ミミッキュは\nつるぎのまいを つかった!', 8310: '相手の ミミッキュは\nつるぎのまいを つかった!', 8325: '相手の ミミッキュは\nつるぎのまいを つかった!', 8475: '相手の ミミッキュの\n攻撃が ぐーんと上がった!', 8490: '相手の ミミッキュの\n攻撃が ぐーんと上がった!', 8520: 'トゲキッスの\nダイジェット!', 8535: 'トゲキッスの\nダイジェット!', 8550: 'トゲキッスの\nダイジェット!', 8805: 'トゲキッスの\n素早さが 上がった!', 8865: 'ばけのかわが みがわりに なった!', 8970: '相手の ミミッキュの\nばけのかわが はがれた!', 9495: '通信待機中…', 9510: '通信待機中 ....', 9525: '通信待機中…', 9555: '相手の ミミッキュの\nかげうち!', 9570: '相手の ミミッキュの\nかけうち!', 9585: '相手の ミミッキュの\nかげうち!', 9705: 'トゲキッスの\nエアスラッシュ!', 9720: 'トゲキッスの\nエアスラッシュ!', 9735: 'トゲキッスの\nエアスラッシュ!', 9915: '通信待機中…', 9930: '通信待機中…', 9945: '通信待機中…', 9960: '通信待機中…', 9975: '通信待機中…', 10020: '相手の ミミッキュの\nかげうち!', 10035: '相手の ミミッキュの\nかげうち!', 10050: '相手の ミミッキュの\nかげうち!', 10155: 'トゲキッスは たおれた!', 10170: 'トゲキッスは たおれた!', 10365: '通信待機中…', 10380: '通信待機中 ...', 10395: '通信待機中 ...', 10425: 'がんばれ! ウインディ!', 10725: '通信待機中…', 10740: '通信待機中 ……', 10755: '通信待機中…', 10800: '相手の ミミッキュの\nドレインパンチ!', 10815: '相手の ミミッキュの\nドレインパンチ!', 10830: '相手の ミミッキュの\nドレインパンチ!', 11055: 'ウインディから\n体力を 吸い取った!', 11100: 'ウインディの\nフレアドライブ!', 11115: 'ウインディの\nフレアドライブ!', 11130: 'ウインディの\nフレアドライブ!', 11295: '相手の ミミッキュは たおれた!', 11430: 'ウインディは\n反動による ダメージを 受けた!', 11490: 'ウインディは\n命が 少し削られた!', 11535: 'パーソンとの\n勝負に 勝つた!'}


class SegmentTextsRealDataTest(TestCase):

    def test(self):
        with open("data/ocr_result.pickle", "rb") as f:
            data = pickle.load(f)

        results = []
        for i, item in enumerate(data["result"]):
            result = segment_texts(item, 98, 24)
            self.assertSequenceEqual(EXPECTED_SEGMENT[i], result)
            results.append(result)

        timestamps = data["timestamps"]
        timestamped = add_timestamp(results, timestamps, 68)
        print(timestamped)
        self.assertDictEqual(EXPECTED_TIMESTAMPED, timestamped)
